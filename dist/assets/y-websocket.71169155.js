import{s as K,o as X,v as Z,t as v,f as ee,c as te,w as i,e as se,a as y,b as ne,r as _,d as B,g as ce,h as P,O as W,i as ae,j as b,k as j,l as g,m as oe,n as f,p as O,q as ie,u as Y,x as le,y as he}from"./yjs.abf8fc34.js";const $=new Map;class de{constructor(t){this.room=t,this.onmessage=null,X(s=>s.key===t&&this.onmessage!==null&&this.onmessage({data:ee(s.newValue||"")}))}postMessage(t){Z.setItem(this.room,v(te(t)))}}const ue=typeof BroadcastChannel>"u"?de:BroadcastChannel,T=e=>K($,e,()=>{const t=new Set,s=new ue(e);return s.onmessage=n=>t.forEach(c=>c(n.data,"broadcastchannel")),{bc:s,subs:t}}),re=(e,t)=>(T(e).subs.add(t),t),fe=(e,t)=>{const s=T(e),n=s.subs.delete(t);return n&&s.subs.size===0&&(s.bc.close(),$.delete(e)),n},p=(e,t,s=null)=>{const n=T(e);n.bc.postMessage(t),n.subs.forEach(c=>c(t,s))},N=0,R=1,Q=2,H=(e,t)=>{i(e,N);const s=se(t);y(e,s)},q=(e,t,s)=>{i(e,R),y(e,ne(t,s))},ge=(e,t,s)=>q(t,s,B(e)),F=(e,t,s)=>{try{ce(t,B(e),s)}catch(n){console.error("Caught error while handling a Yjs update",n)}},me=(e,t)=>{i(e,Q),y(e,t)},we=F,ye=(e,t,s,n)=>{const c=_(e);switch(c){case N:ge(e,t,s);break;case R:F(e,s,n);break;case Q:we(e,s,n);break;default:throw new Error("Unknown message type")}return c},Se=0,be=(e,t,s)=>{switch(_(e)){case Se:s(t,P(e))}},L=3e4;class pe extends W{constructor(t){super(),this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const s=b();this.getLocalState()!==null&&L/2<=s-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const n=[];this.meta.forEach((c,a)=>{a!==this.clientID&&L<=s-c.lastUpdated&&this.states.has(a)&&n.push(a)}),n.length>0&&x(this,n,"timeout")},ae(L/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){const s=this.clientID,n=this.meta.get(s),c=n===void 0?0:n.clock+1,a=this.states.get(s);t===null?this.states.delete(s):this.states.set(s,t),this.meta.set(s,{clock:c,lastUpdated:b()});const o=[],m=[],l=[],w=[];t===null?w.push(s):a==null?t!=null&&o.push(s):(m.push(s),j(a,t)||l.push(s)),(o.length>0||l.length>0||w.length>0)&&this.emit("change",[{added:o,updated:l,removed:w},"local"]),this.emit("update",[{added:o,updated:m,removed:w},"local"])}setLocalStateField(t,s){const n=this.getLocalState();n!==null&&this.setLocalState({...n,[t]:s})}getStates(){return this.states}}const x=(e,t,s)=>{const n=[];for(let c=0;c<t.length;c++){const a=t[c];if(e.states.has(a)){if(e.states.delete(a),a===e.clientID){const o=e.meta.get(a);e.meta.set(a,{clock:o.clock+1,lastUpdated:b()})}n.push(a)}}n.length>0&&(e.emit("change",[{added:[],updated:[],removed:n},s]),e.emit("update",[{added:[],updated:[],removed:n},s]))},U=(e,t,s=e.states)=>{const n=t.length,c=g();i(c,n);for(let a=0;a<n;a++){const o=t[a],m=s.get(o)||null,l=e.meta.get(o).clock;i(c,o),i(c,l),oe(c,JSON.stringify(m))}return f(c)},_e=(e,t,s)=>{const n=O(t),c=b(),a=[],o=[],m=[],l=[],w=_(n);for(let C=0;C<w;C++){const h=_(n);let d=_(n);const u=JSON.parse(P(n)),r=e.meta.get(h),E=e.states.get(h),A=r===void 0?0:r.clock;(A<d||A===d&&u===null&&e.states.has(h))&&(u===null?h===e.clientID&&e.getLocalState()!=null?d++:e.states.delete(h):e.states.set(h,u),e.meta.set(h,{clock:d,lastUpdated:c}),r===void 0&&u!==null?a.push(h):r!==void 0&&u===null?l.push(h):u!==null&&(j(u,E)||m.push(h),o.push(h)))}(a.length>0||m.length>0||l.length>0)&&e.emit("change",[{added:a,updated:m,removed:l},s]),(a.length>0||o.length>0||l.length>0)&&e.emit("update",[{added:a,updated:o,removed:l},s])},Ie=e=>ie(e,(t,s)=>`${encodeURIComponent(s)}=${encodeURIComponent(t)}`).join("&"),S=0,J=3,I=1,Ue=2,k=[];k[S]=(e,t,s,n,c)=>{i(e,S);const a=ye(t,e,s.doc,s);n&&a===R&&!s.synced&&(s.synced=!0)};k[J]=(e,t,s,n,c)=>{i(e,I),y(e,U(s.awareness,Array.from(s.awareness.getStates().keys())))};k[I]=(e,t,s,n,c)=>{_e(s.awareness,B(t),s)};k[Ue]=(e,t,s,n,c)=>{be(t,s.doc,(a,o)=>ke(s,o))};const V=3e4,ke=(e,t)=>console.warn(`Permission denied to access ${e.url}.
${t}`),z=(e,t,s)=>{const n=O(t),c=g(),a=_(n),o=e.messageHandlers[a];return o?o(c,n,e,s,a):console.error("Unable to compute message"),c},G=e=>{if(e.shouldConnect&&e.ws===null){const t=new e._WS(e.url);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=s=>{e.wsLastMessageReceived=b();const n=z(e,new Uint8Array(s.data),!0);Y(n)>1&&t.send(f(n))},t.onerror=s=>{e.emit("connection-error",[s,e])},t.onclose=s=>{e.emit("connection-close",[s,e]),e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,x(e.awareness,Array.from(e.awareness.getStates().keys()).filter(n=>n!==e.doc.clientID),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(G,le(he(2,e.wsUnsuccessfulReconnects)*100,e.maxBackoffTime),e)},t.onopen=()=>{e.wsLastMessageReceived=b(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const s=g();if(i(s,S),H(s,e.doc),t.send(f(s)),e.awareness.getLocalState()!==null){const n=g();i(n,I),y(n,U(e.awareness,[e.doc.clientID])),t.send(f(n))}},e.emit("status",[{status:"connecting"}])}},M=(e,t)=>{e.wsconnected&&e.ws.send(t),e.bcconnected&&p(e.bcChannel,t,e)};class Ae extends W{constructor(t,s,n,{connect:c=!0,awareness:a=new pe(n),params:o={},WebSocketPolyfill:m=WebSocket,resyncInterval:l=-1,maxBackoffTime:w=2500,disableBc:C=!1}={}){for(super();t[t.length-1]==="/";)t=t.slice(0,t.length-1);const h=Ie(o);this.maxBackoffTime=w,this.bcChannel=t+"/"+s,this.url=t+"/"+s+(h.length===0?"":"?"+h),this.roomname=s,this.doc=n,this._WS=m,this.awareness=a,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=C,this.wsUnsuccessfulReconnects=0,this.messageHandlers=k.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=c,this._resyncInterval=0,l>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const d=g();i(d,S),H(d,n),this.ws.send(f(d))}},l)),this._bcSubscriber=(d,u)=>{if(u!==this){const r=z(this,new Uint8Array(d),!1);Y(r)>1&&p(this.bcChannel,f(r),this)}},this._updateHandler=(d,u)=>{if(u!==this){const r=g();i(r,S),me(r,d),M(this,f(r))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:d,updated:u,removed:r},E)=>{const A=d.concat(u).concat(r),D=g();i(D,I),y(D,U(a,A)),M(this,f(D))},this._unloadHandler=()=>{x(this.awareness,[n.clientID],"window unload")},typeof window<"u"?window.addEventListener("unload",this._unloadHandler):typeof process<"u"&&process.on("exit",this._unloadHandler),a.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&V<b()-this.wsLastMessageReceived&&this.ws.close()},V/10),c&&this.connect()}get synced(){return this._synced}set synced(t){this._synced!==t&&(this._synced=t,this.emit("synced",[t]),this.emit("sync",[t]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),typeof window<"u"?window.removeEventListener("unload",this._unloadHandler):typeof process<"u"&&process.off("exit",this._unloadHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||(re(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);const t=g();i(t,S),H(t,this.doc),p(this.bcChannel,f(t),this);const s=g();i(s,S),q(s,this.doc),p(this.bcChannel,f(s),this);const n=g();i(n,J),p(this.bcChannel,f(n),this);const c=g();i(c,I),y(c,U(this.awareness,[this.doc.clientID])),p(this.bcChannel,f(c),this)}disconnectBc(){const t=g();i(t,I),y(t,U(this.awareness,[this.doc.clientID],new Map)),M(this,f(t)),this.bcconnected&&(fe(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&this.ws.close()}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(G(this),this.connectBc())}}export{Ae as W};
